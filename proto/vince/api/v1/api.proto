syntax = "proto3";
package v1;

import "google/protobuf/duration.proto";
import "vince/config/v1/config.proto";
import "google/protobuf/timestamp.proto";

service Vince {
  rpc CreateToken(CreateTokenRequest) returns (CreateTokenResponse);
  rpc CreateSite(CreateSiteRequest) returns (CreateSiteResponse);
  rpc GetSite(GetSiteRequest) returns (GetSiteResponse);
  rpc ListSites(ListSitesRequest) returns (ListSitesResponse);
  rpc DeleteSite(DeleteSiteRequest) returns (DeleteSiteResponse);
  rpc Query(QueryRequest) returns (QueryResponse);
  rpc ApplyCluster(ApplyClusterRequest) returns (ApplyClusterResponse);
  rpc GetCluster(GetClusterRequest) returns (GetClusterResponse);
}

message Token {
  bytes pub_key = 1;

  enum Issuer {
    SERVER = 0;
    CLIENT = 1;
  }
}

message CreateTokenRequest {
  string name = 1;
  string password = 2;
  string token = 3;
  bytes public_key = 4;
  // When true, the token will be generated by the server.
  bool generate = 5;
  google.protobuf.Duration ttl = 6;
}

message CreateTokenResponse { Client.Auth auth = 1; }

message Site { string domain = 1; }
message CreateSiteRequest { string domain = 1; }
message CreateSiteResponse { Site site = 1; }
message GetSiteRequest {}
message GetSiteResponse { Site site = 1; }
message ListSitesRequest {}
message ListSitesResponse { repeated Site list = 1; }
message DeleteSiteRequest { string domain = 1; }
message DeleteSiteResponse {}

message Account {
  string name = 1;
  bytes hashed_password = 2;
}

message Error {
  string error = 1;
  int32 code = 2;
}

message Query {
  message Value {
    oneof value {
      int64 number = 1;
      double double = 2;
      string string = 3;
      bool bool = 4;
      google.protobuf.Timestamp timestamp = 5;
    }
  }

  message Param {
    string name = 1;
    Value value = 2;
  }

  message Colum {
    string name = 1;
    DataType data_type = 2;

    enum DataType {
      UNKNOWN = 0;
      NUMBER = 1;
      DOUBLE = 2;
      STRING = 3;
      BOOL = 4;
      TIMESTAMP = 5;
    }
  }
  message Row { repeated Value values = 1; }
}

message QueryRequest {
  string query = 1;
  repeated Query.Param params = 2;
}

message QueryResponse {
  google.protobuf.Duration elapsed = 1;
  repeated Query.Colum columns = 2;
  repeated Query.Row rows = 3;
}

message ApplyClusterRequest { Cluster.Config config = 1; }
message ApplyClusterResponse { string ok = 1; }

message GetClusterRequest {}
message GetClusterResponse { Cluster.Config config = 1; }

message Status {}

message Notice {}
